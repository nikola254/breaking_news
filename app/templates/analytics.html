{% extends "base.html" %}

{% block title %}NewsAnalytics - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        background-color: #0d2b50;
        color: #e0e0e0;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .stats-card {
        background-color: #1e3a6a;
        color: #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: all 0.3s;
        border: 1px solid #4fc3f7;
    }
    
    .stats-card:hover {
        background-color: #2d4a7a;
        transform: translateY(-2px);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #4fc3f7;
    }
    
    .stats-label {
        font-size: 0.9rem;
        color: #bbdefb;
    }
    
    .filter-card {
        background-color: #1e3a6a;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
        color: #e0e0e0;
    }
    
    .chart-card {
        background-color: #1e3a6a;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
        margin-bottom: 2rem;
        color: #e0e0e0;
    }
    
    .chart-card .card-header {
        background-color: #0288d1;
        color: white;
        border-radius: 8px 8px 0 0;
        border: none;
    }
    
    .alert-card {
        background-color: #1e3a6a;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
        margin-bottom: 2rem;
        color: #e0e0e0;
    }
    
    .alert-card .card-header {
        background-color: #0288d1;
        color: white;
        border-radius: 8px 8px 0 0;
        border: none;
    }
    
    .tension-alert {
        background-color: #2d4a7a;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border: none;
        color: #bbdefb;
    }
    
    .tension-alert.critical {
        background-color: #d32f2f;
        color: white;
    }
    
    .tension-alert.high {
        background-color: #f57c00;
        color: white;
    }
    
    .tension-badge {
        background-color: #0288d1;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .category-badge {
        background-color: #4fc3f7;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .news-table {
        background-color: #1e3a6a;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
    }
    
    .news-table th {
        background-color: #0288d1;
        color: white;
        border: none;
        padding: 1rem;
        font-weight: 600;
    }
    
    .news-table td {
        background-color: #1e3a6a;
        color: #e0e0e0;
        border: none;
        padding: 1rem;
        border-bottom: 1px solid #2d4a7a;
        vertical-align: middle;
    }
    
    .news-table tbody tr:hover {
        background-color: #2d4a7a;
        transition: background-color 0.3s ease;
    }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
    }
    
    .spinner-custom {
        width: 3rem;
        height: 3rem;
        border: 0.3rem solid #f3f3f3;
        border-top: 0.3rem solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .btn-analytics {
        background: linear-gradient(135deg, #0288d1 0%, #1976d2 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-analytics:hover {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
        color: white;
    }
    
    .form-control {
        background-color: #2d4a7a;
        border: 1px solid #4fc3f7;
        border-radius: 4px;
        color: #e0e0e0;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        background-color: #2d4a7a;
        border-color: #0288d1;
        box-shadow: 0 0 0 0.2rem rgba(79, 195, 247, 0.25);
        color: #e0e0e0;
    }
    
    .test-category-highlight {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        border-left: 4px solid #667eea;
        padding: 0.5rem;
        border-radius: 5px;
        margin-bottom: 0.5rem;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ–º–æ-–≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    .chart-placeholder {
        padding: 2rem;
        text-align: center;
    }
    
    .chart-demo {
        position: relative;
        height: 200px;
        background-color: #2d4a7a;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
        border: 1px solid #4fc3f7;
    }
    
    .chart-line {
        position: relative;
        height: 100%;
        background: linear-gradient(to right, #667eea, #764ba2);
        opacity: 0.1;
    }
    
    .chart-point {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #667eea;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .chart-labels {
        display: flex;
        justify-content: space-between;
        padding: 0 1rem;
        margin-top: 1rem;
        font-size: 0.8rem;
        color: #666;
    }
    
    .pie-chart-demo {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
    }
    
    .pie-slice {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 5px;
        background: var(--color);
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .heatmap-demo {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
    }
    
    .heatmap-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .source-label {
        min-width: 100px;
        font-size: 0.8rem;
        font-weight: bold;
        color: #666;
    }
    
    .heat-cell {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        margin: 0 2px;
    }
    
    .heat-cell.high {
        background: #e74c3c;
        animation: glow-red 2s infinite;
    }
    
    .heat-cell.medium {
        background: #f39c12;
        animation: glow-orange 2s infinite;
    }
    
    .heat-cell.low {
        background: #2ecc71;
        animation: glow-green 2s infinite;
    }
    
    @keyframes glow-red {
        0%, 100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
        50% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
    }
    
    @keyframes glow-orange {
        0%, 100% { box-shadow: 0 0 5px rgba(243, 156, 18, 0.5); }
        50% { box-shadow: 0 0 15px rgba(243, 156, 18, 0.8); }
    }
    
    @keyframes glow-green {
        0%, 100% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.5); }
        50% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.8); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="analytics-header text-center">
        <h1 class="mb-3">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h1>
        <p class="mb-0">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</p>
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="mb-0">üîç –§–∏–ª—å—Ç—Ä—ã</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="categorySelect" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select class="form-control" id="categorySelect">
                            <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <option value="military_operations">–í–æ–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                            <option value="humanitarian_crisis">–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π –∫—Ä–∏–∑–∏—Å</option>
                            <option value="economic_consequences">–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è</option>
                            <option value="political_decisions">–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è</option>
                            <option value="information_social">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã</option>
                            <option value="other">–ü—Ä–æ—á–µ–µ</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="dateRange" class="form-label">–ü–µ—Ä–∏–æ–¥:</label>
                        <select class="form-control" id="dateRange">
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                        </select>
                    </div>
                    <button class="btn btn-analytics w-100" onclick="updateAnalytics()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="mb-0">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-number" id="totalNews">-</div>
                                <div class="stats-label">üì∞ –í—Å–µ–≥–æ –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-number" id="avgTension">-</div>
                                <div class="stats-label">üå°Ô∏è –°—Ä–µ–¥–Ω—è—è –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-number" id="trendIndicator">-</div>
                                <div class="stats-label">üìä –¢—Ä–µ–Ω–¥</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-number" id="socialActivity">-</div>
                                <div class="stats-label">üî• –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    
    <!-- –ê–ª–µ—Ä—Ç—ã –æ –≤—ã—Å–æ–∫–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏ -->
    <div class="row">
        <div>
            <div class="card alert-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üö® –ê–ª–µ—Ä—Ç—ã –æ –≤—ã—Å–æ–∫–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</h5>
                </div>
                <div class="card-body">
                    <div id="tensionAlerts">
                        <div class="loading-spinner">
                            <div class="spinner-custom"></div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="row">
        <div>
            <div class="card chart-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üìà –î–∏–Ω–∞–º–∏–∫–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</h5>
                </div>
                <div class="card-body">
                    <div id="tensionChart" class="text-center">
                        <div class="loading-spinner">
                            <div class="spinner-custom"></div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card chart-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ü•ß –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
                </div>
                <div class="card-body">
                    <div id="categoryChart" class="text-center">
                        <div class="loading-spinner">
                            <div class="spinner-custom"></div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card chart-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</h5>
                </div>
                <div class="card-body">
                    <div id="sourcesChart" class="text-center">
                        <div class="loading-spinner">
                            <div class="spinner-custom"></div>
                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π -->
    <div class="row">
        <div>
            <div class="card chart-card">
                <div class="card-header">
                    <h5 class="mb-0">üì∞ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table news-table" id="newsTable">
                            <thead>
                                <tr>
                                    <th>‚è∞ –í—Ä–µ–º—è</th>
                                    <th>üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                                    <th>üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th>üå°Ô∏è –ù–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å</th>
                                    <th>üì° –ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner">
                                            <div class="spinner-custom"></div>
                                            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
function updateAnalytics() {
    const category = document.getElementById('categorySelect').value;
    const dateRange = document.getElementById('dateRange').value;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
    showLoadingSpinners();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    loadStatistics(category, dateRange);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    loadCharts(category, dateRange);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–æ–≤–æ—Å—Ç–µ–π
    loadNewsTable(category, dateRange);
}

function showLoadingSpinners() {
    document.getElementById('tensionChart').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>`;
    
    document.getElementById('categoryChart').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>`;
    
    document.getElementById('sourcesChart').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>`;
}

function loadStatistics(category, dateRange) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    fetch(`/api/ukraine_analytics/statistics?category=${category}&days=${dateRange}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('totalNews').textContent = data.total_news || '0';
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            document.getElementById('totalNews').textContent = '–û—à–∏–±–∫–∞';
        });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
    fetch(`/api/ukraine_analytics/social_tension_statistics?category=${category}&days=${dateRange}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('avgTension').textContent = 
                    data.avg_tension ? data.avg_tension.toFixed(1) + '%' : '0%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç—Ä–µ–Ω–¥–∞
                const trendElement = document.getElementById('tensionTrend');
                if (trendElement) {
                    trendElement.textContent = getTrendText(data.trend);
                    trendElement.className = `trend-indicator ${data.trend}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
                updateTensionDistribution(data.tension_distribution);
            }
        })
        .catch(error => {
            console.error('Error loading tension statistics:', error);
            document.getElementById('avgTension').textContent = '–û—à–∏–±–∫–∞';
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ç—Ä–µ–Ω–¥–∞
function getTrendText(trend) {
    switch(trend) {
        case 'rising': return '‚Üó –†–∞—Å—Ç–µ—Ç';
        case 'falling': return '‚Üò –°–Ω–∏–∂–∞–µ—Ç—Å—è';
        case 'stable': return '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ';
        default: return '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
function updateTensionDistribution(distribution) {
    const container = document.getElementById('tensionDistribution');
    if (!container || !distribution) return;
    
    const categories = {
        'critical': { name: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è', color: '#8e44ad' },
        'high': { name: '–í—ã—Å–æ–∫–∞—è', color: '#e74c3c' },
        'medium': { name: '–°—Ä–µ–¥–Ω—è—è', color: '#e67e22' },
        'low': { name: '–ù–∏–∑–∫–∞—è', color: '#f1c40f' },
        'minimal': { name: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è', color: '#2ecc71' }
    };
    
    let html = '<div class="tension-distribution">';
    for (const [level, count] of Object.entries(distribution)) {
        const category = categories[level];
        if (category && count > 0) {
            html += `
                <div class="tension-item">
                    <span class="tension-color" style="background-color: ${category.color}"></span>
                    <span class="tension-label">${category.name}</span>
                    <span class="tension-count">${count}</span>
                </div>
            `;
        }
    }
    html += '</div>';
    container.innerHTML = html;
}

function loadCharts(category, dateRange) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –∫—Ä–∞—Å–∏–≤—ã–º –¥–∏–∑–∞–π–Ω–æ–º
    
    // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
    document.getElementById('tensionChart').innerHTML = `
        <div class="chart-placeholder">
            <div class="chart-demo">
                <div class="chart-line">
                    <div class="chart-point" style="left: 10%; bottom: 30%"></div>
                    <div class="chart-point" style="left: 25%; bottom: 45%"></div>
                    <div class="chart-point" style="left: 40%; bottom: 60%"></div>
                    <div class="chart-point" style="left: 55%; bottom: 40%"></div>
                    <div class="chart-point" style="left: 70%; bottom: 75%"></div>
                    <div class="chart-point" style="left: 85%; bottom: 55%"></div>
                </div>
                <div class="chart-labels">
                    <span>–Ø–Ω–≤</span><span>–§–µ–≤</span><span>–ú–∞—Ä</span><span>–ê–ø—Ä</span><span>–ú–∞–π</span><span>–ò—é–Ω</span>
                </div>
            </div>
            <p class="text-muted mt-2">–î–µ–º–æ: –î–∏–Ω–∞–º–∏–∫–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</p>
        </div>
    `;
    
    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    document.getElementById('categoryChart').innerHTML = `
        <div class="chart-placeholder">
            <div class="pie-chart-demo">
                <div class="pie-slice" style="--percentage: 35; --color: #e74c3c;">–í–æ–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (35%)</div>
                <div class="pie-slice" style="--percentage: 25; --color: #3498db;">–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è (25%)</div>
                <div class="pie-slice" style="--percentage: 20; --color: #f39c12;">–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ (20%)</div>
                <div class="pie-slice" style="--percentage: 20; --color: #2ecc71;">–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ (20%)</div>
            </div>
            <p class="text-muted mt-2">–î–µ–º–æ: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</p>
        </div>
    `;
    
    // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
    document.getElementById('sourcesChart').innerHTML = `
        <div class="chart-placeholder">
            <div class="heatmap-demo">
                <div class="heatmap-row">
                    <span class="source-label">–†–ò–ê –ù–æ–≤–æ—Å—Ç–∏</span>
                    <div class="heat-cell high"></div>
                    <div class="heat-cell medium"></div>
                    <div class="heat-cell low"></div>
                </div>
                <div class="heatmap-row">
                    <span class="source-label">–õ–µ–Ω—Ç–∞.—Ä—É</span>
                    <div class="heat-cell medium"></div>
                    <div class="heat-cell high"></div>
                    <div class="heat-cell medium"></div>
                </div>
                <div class="heatmap-row">
                    <span class="source-label">–†–ë–ö</span>
                    <div class="heat-cell low"></div>
                    <div class="heat-cell medium"></div>
                    <div class="heat-cell high"></div>
                </div>
            </div>
            <p class="text-muted mt-2">–î–µ–º–æ: –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏</p>
        </div>
    `;
}

function loadNewsTable(category, dateRange) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API —ç–Ω–¥–ø–æ–∏–Ω—Ç
    const apiUrl = category === 'all' ? '/api/news?limit=20' : `/api/news?category=${category}&limit=20`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.data && Array.isArray(data.data)) {
                const tbody = document.querySelector('#newsTable tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                data.data.forEach(news => {
                    const row = document.createElement('tr');
                    const isTestCategory = news.category && news.category.startsWith('test_');
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π tension_score –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    const tensionScore = Math.random() * 10;
                    
                    row.innerHTML = `
                        <td>
                            <small class="text-muted">${formatDate(news.published_date)}</small>
                        </td>
                        <td>
                            <div class="fw-bold">
                                <a href="${news.link || '#'}" target="_blank" class="text-decoration-none">${news.title}</a>
                            </div>
                            ${news.content ? `<small class="text-muted">${news.content.substring(0, 100)}...</small>` : ''}
                        </td>
                        <td>
                            <span class="category-badge ${isTestCategory ? 'test-category' : ''}">${getCategoryName(news.category)}</span>
                        </td>
                        <td>
                            <span class="tension-badge ${getTensionColorClass(tensionScore)}">${tensionScore.toFixed(1)}%</span>
                        </td>
                        <td>
                            <small class="text-muted">${news.source}</small>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                document.querySelector('#newsTable tbody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading news table:', error);
            document.querySelector('#newsTable tbody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                        </div>
                    </td>
                </tr>
            `;
        });
}

function getTensionColorClass(score) {
    if (score >= 8) return 'critical';
    if (score >= 6) return 'high';
    if (score >= 4) return 'medium';
    return 'low';
}

function getTensionColor(score) {
    if (score < 0.3) return '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
    if (score < 0.6) return '#ffc107'; // –ñ–µ–ª—Ç—ã–π
    return '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
}

function getCategoryName(category) {
    const categories = {
        // –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        'test_military': 'üéØ –¢–µ—Å—Ç: –í–æ–µ–Ω–Ω—ã–µ',
        'test_diplomatic': 'ü§ù –¢–µ—Å—Ç: –î–∏–ø–ª–æ–º–∞—Ç–∏—è',
        'test_economic': 'üí∞ –¢–µ—Å—Ç: –≠–∫–æ–Ω–æ–º–∏–∫–∞',
        'test_humanitarian': '‚ù§Ô∏è –¢–µ—Å—Ç: –ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ',
        'test_information': 'üì± –¢–µ—Å—Ç: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ',
        // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        'military_operations': '–í–æ–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        'humanitarian_crisis': '–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π –∫—Ä–∏–∑–∏—Å',
        'economic_consequences': '–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è',
        'political_decisions': '–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è',
        'information_social': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã',
        'other': '–ü—Ä–æ—á–µ–µ'
    };
    return categories[category] || category;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ –æ –≤—ã—Å–æ–∫–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏
function loadTensionAlerts() {
    fetch('/api/ukraine_analytics/tension_alerts')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayTensionAlerts(data.alerts);
            }
        })
        .catch(error => {
            console.error('Error loading tension alerts:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤
function displayTensionAlerts(alerts) {
    const alertsContainer = document.getElementById('tensionAlerts');
    if (!alertsContainer) return;

    if (alerts.length === 0) {
        alertsContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤</p>
                <small class="text-muted">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ</small>
            </div>
        `;
        return;
    }

    let alertsHtml = '<div class="tension-alerts">';
    alerts.forEach(alert => {
        const levelIcon = {
            'critical': 'üö®',
            'high': '‚ö†Ô∏è',
            'medium': 'üìä',
            'low': '‚ÑπÔ∏è'
        }[alert.level] || 'üì¢';
        
        alertsHtml += `
            <div class="tension-alert ${alert.level}">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <span style="font-size: 1.5rem;">${levelIcon}</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${alert.category}</h6>
                        <p class="mb-2">${alert.description}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="opacity-75">
                                <i class="fas fa-clock me-1"></i>
                                ${alert.time}
                            </small>
                            <span class="tension-badge">
                                ${alert.tension_score.toFixed(1)}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    alertsHtml += '</div>';
    
    alertsContainer.innerHTML = alertsHtml;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateAnalytics();
    loadTensionAlerts();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(loadTensionAlerts, 300000);
});
</script>
{% endblock %}