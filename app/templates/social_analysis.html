{% extends "base.html" %}

{% block title %}Анализ социальных сетей{% endblock %}

{% block extra_head %}
<style>
/* Стили для выделения ключевых слов */
.keyword-violence { background-color: #ffebee; color: #c62828; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
.keyword-hate { background-color: #fff3e0; color: #ef6c00; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
.keyword-extremism { background-color: #fce4ec; color: #ad1457; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
.keyword-terrorism { background-color: #f3e5f5; color: #7b1fa2; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
.keyword-drugs { background-color: #e8f5e8; color: #2e7d32; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
.keyword-weapons { background-color: #e3f2fd; color: #1565c0; font-weight: bold; padding: 2px 4px; border-radius: 3px; }

/* Стили для классификатора экстремистского контента */
.threat-keyword { background-color: #ffebee; color: #d32f2f; font-weight: bold; padding: 2px 4px; border-radius: 3px; border: 1px solid #d32f2f; }
.hate-keyword { background-color: #fff3e0; color: #f57c00; font-weight: bold; padding: 2px 4px; border-radius: 3px; border: 1px solid #f57c00; }
.extremist-keyword { background-color: #fffde7; color: #f9a825; font-weight: bold; padding: 2px 4px; border-radius: 3px; border: 1px solid #f9a825; }

/* Стили для уровней угрозы */
.threat-critical { border-left-color: #d32f2f !important; }
.threat-high { border-left-color: #f57c00 !important; }
.threat-medium { border-left-color: #fbc02d !important; }
.threat-low { border-left-color: #388e3c !important; }
.threat-minimal { border-left-color: #6c757d !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Анализ социальных сетей</h1>
            
            <!-- Навигационные вкладки -->
            <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">Анализ аккаунта</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="keyword-tab" data-bs-toggle="tab" data-bs-target="#keyword" type="button" role="tab">Поиск по ключевым словам</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">Мониторинг</button>
                </li>
            </ul>
            
            <!-- Содержимое вкладок -->
            <div class="tab-content" id="analysisTabContent">
                <!-- Анализ аккаунта -->
                <div class="tab-pane fade show active" id="account" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Анализ конкретного аккаунта</h5>
                        </div>
                        <div class="card-body">
                            <form id="accountAnalysisForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="platform" class="form-label">Платформа</label>
                                            <select class="form-select" id="platform" name="platform" required>
                                                <option value="">Выберите платформу</option>
                                                <option value="vk">VKontakte</option>
                                                <option value="telegram">Telegram</option>
                                                <option value="ok">Одноклассники</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="accountUrl" class="form-label">URL аккаунта или ID</label>
                                            <input type="text" class="form-control" id="accountUrl" name="account_url" placeholder="https://vk.com/username или @username" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="postsLimit" class="form-label">Количество постов для анализа</label>
                                            <input type="number" class="form-control" id="postsLimit" name="posts_limit" value="50" min="1" max="1000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="analysisType" class="form-label">Тип анализа</label>
                                            <select class="form-select" id="analysisType" name="analysis_type">
                                                <option value="full">Полный анализ</option>
                                                <option value="extremism">Только экстремизм</option>
                                                <option value="sentiment">Анализ тональности</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="startAccountAnalysis">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    Начать анализ
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Результаты анализа аккаунта -->
                    <div class="card mt-3 d-none" id="accountResults">
                        <div class="card-header">
                            <h5>Результаты анализа</h5>
                        </div>
                        <div class="card-body" id="accountResultsContent">
                            <!-- Результаты будут загружены здесь -->
                        </div>
                    </div>
                </div>
                
                <!-- Поиск по ключевым словам -->
                <div class="tab-pane fade" id="keyword" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Поиск контента по ключевым словам</h5>
                        </div>
                        <div class="card-body">
                            <form id="keywordSearchForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="keywords" class="form-label">Ключевые слова</label>
                                            <textarea class="form-control" id="keywords" name="keywords" rows="3" placeholder="Введите ключевые слова через запятую" required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="searchPlatforms" class="form-label">Платформы</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="vk" id="searchVk" name="platforms" checked>
                                                <label class="form-check-label" for="searchVk">VKontakte</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="telegram" id="searchTelegram" name="platforms" checked>
                                                <label class="form-check-label" for="searchTelegram">Telegram</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="ok" id="searchOk" name="platforms">
                                                <label class="form-check-label" for="searchOk">Одноклассники</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success" id="startKeywordSearch">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    Начать поиск
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Результаты поиска -->
                    <div class="card mt-3 d-none" id="keywordResults">
                        <div class="card-header">
                            <h5>Результаты поиска</h5>
                        </div>
                        <div class="card-body" id="keywordResultsContent">
                            <!-- Результаты будут загружены здесь -->
                        </div>
                    </div>
                </div>
                
                <!-- Мониторинг -->
                <div class="tab-pane fade" id="monitoring" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Настройка мониторинга</h5>
                        </div>
                        <div class="card-body">
                            <form id="monitoringForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringPlatform" class="form-label">Платформа</label>
                                            <select class="form-select" id="monitoringPlatform" name="platform" required>
                                                <option value="">Выберите платформу</option>
                                                <option value="vk">VKontakte</option>
                                                <option value="telegram">Telegram</option>
                                                <option value="ok">Одноклассники</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringName" class="form-label">Название сессии</label>
                                            <input type="text" class="form-control" id="monitoringName" name="session_name" placeholder="Мониторинг экстремизма" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringInterval" class="form-label">Интервал проверки (минуты)</label>
                                            <input type="number" class="form-control" id="monitoringInterval" name="interval" value="60" min="5" max="1440">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="monitoringKeywords" class="form-label">Ключевые слова для мониторинга</label>
                                    <textarea class="form-control" id="monitoringKeywords" name="monitoring_keywords" rows="3" placeholder="Введите ключевые слова через запятую" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-warning" id="startMonitoring">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                    Запустить мониторинг
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Активные сессии мониторинга -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Активные сессии мониторинга</h5>
                        </div>
                        <div class="card-body" id="activeSessions">
                            <p class="text-muted">Загрузка активных сессий...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения подробных результатов -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подробные результаты</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalResultsContent">
                <!-- Подробные результаты -->
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript для обработки форм
document.addEventListener('DOMContentLoaded', function() {
    // Анализ аккаунта
    document.getElementById('accountAnalysisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const button = document.getElementById('startAccountAnalysis');
        const spinner = button.querySelector('.spinner-border');
        const resultsDiv = document.getElementById('accountResults');
        const resultsContent = document.getElementById('accountResultsContent');
        
        // Показать спиннер
        spinner.classList.remove('d-none');
        button.disabled = true;
        
        const formData = new FormData(this);
        
        fetch('/social-analysis/analyze-account', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsContent.innerHTML = formatAccountResults(data.results);
                resultsDiv.classList.remove('d-none');
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при анализе');
        })
        .finally(() => {
            spinner.classList.add('d-none');
            button.disabled = false;
        });
    });
    
    // Поиск по ключевым словам
    document.getElementById('keywordSearchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const button = document.getElementById('startKeywordSearch');
        const spinner = button.querySelector('.spinner-border');
        const resultsDiv = document.getElementById('keywordResults');
        const resultsContent = document.getElementById('keywordResultsContent');
        
        // Показать спиннер
        spinner.classList.remove('d-none');
        button.disabled = true;
        
        const formData = new FormData(this);
        
        fetch('/social-analysis/search-keywords', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsContent.innerHTML = formatKeywordResults(data.results);
                resultsDiv.classList.remove('d-none');
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при поиске');
        })
        .finally(() => {
            spinner.classList.add('d-none');
            button.disabled = false;
        });
    });
    
    // Мониторинг
    document.getElementById('monitoringForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const button = document.getElementById('startMonitoring');
        const spinner = button.querySelector('.spinner-border');
        
        // Показать спиннер
        spinner.classList.remove('d-none');
        button.disabled = true;
        
        const formData = new FormData(this);
        
        fetch('/social-analysis/start-monitoring', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Мониторинг запущен успешно!');
                loadActiveSessions();
                this.reset();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при запуске мониторинга');
        })
        .finally(() => {
            spinner.classList.add('d-none');
            button.disabled = false;
        });
    });
    
    // Загрузка активных сессий при загрузке страницы
    loadActiveSessions();
});

// Функция для форматирования результатов анализа аккаунта
function formatAccountResults(results) {
    let html = '<div class="row">';
    
    // Общая информация об аккаунте
    if (results.account_info) {
        html += '<div class="col-12">';
        html += '<h6>Информация об аккаунте</h6>';
        html += '<div class="card">';
        html += '<div class="card-body">';
        html += `<p><strong>Платформа:</strong> ${results.account_info.platform}</p>`;
        html += `<p><strong>Имя:</strong> ${results.account_info.name || 'Неизвестно'}</p>`;
        html += `<p><strong>ID:</strong> ${results.account_info.id || 'Неизвестно'}</p>`;
        if (results.account_info.followers) {
            html += `<p><strong>Подписчики:</strong> ${results.account_info.followers}</p>`;
        }
        html += '</div></div></div>';
    }
    
    // Результаты анализа
    if (results.analysis_results) {
        html += '<div class="col-12 mt-3">';
        html += '<h6>Результаты анализа</h6>';
        
        // Общая статистика
        html += '<div class="row mb-3">';
        html += '<div class="col-md-3">';
        html += '<div class="card text-center">';
        html += '<div class="card-body">';
        html += `<h5 class="card-title text-danger">${results.analysis_results.extremist_count || 0}</h5>`;
        html += '<p class="card-text">Экстремистский контент</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card text-center">';
        html += '<div class="card-body">';
        html += `<h5 class="card-title text-warning">${results.analysis_results.suspicious_count || 0}</h5>`;
        html += '<p class="card-text">Подозрительный контент</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card text-center">';
        html += '<div class="card-body">';
        html += `<h5 class="card-title text-success">${results.analysis_results.normal_count || 0}</h5>`;
        html += '<p class="card-text">Обычный контент</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card text-center">';
        html += '<div class="card-body">';
        html += `<h5 class="card-title text-info">${results.analysis_results.total_analyzed || 0}</h5>`;
        html += '<p class="card-text">Всего проанализировано</p>';
        html += '</div></div></div>';
        html += '</div>';
        
        // Детальные результаты
        if (results.analysis_results.detailed_results && results.analysis_results.detailed_results.length > 0) {
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped">';
            html += '<thead><tr><th>Контент</th><th>Классификация</th><th>Уверенность</th><th>Ключевые слова</th><th>Дата</th></tr></thead>';
            html += '<tbody>';
            
            results.analysis_results.detailed_results.forEach(item => {
                const badgeClass = item.classification === 'extremist' ? 'bg-danger' : 
                                  item.classification === 'suspicious' ? 'bg-warning' : 'bg-success';
                
                const threatColor = item.threat_color || '#6c757d';
                
                html += '<tr>';
                
                // Отображаем выделенный текст с цветовой индикацией
                const displayContent = item.highlighted_text || item.content;
                html += `<td style="border-left: 4px solid ${threatColor}; padding-left: 8px; max-width: 400px;">`;
                html += `<div class="text-break" title="${item.content}">${displayContent}</div>`;
                html += '</td>';
                
                html += `<td><span class="badge ${badgeClass}">${item.classification}</span></td>`;
                html += `<td>${(item.confidence * 100).toFixed(1)}%</td>`;
                
                // Показываем ключевые слова, которые привели к классификации
                html += '<td>';
                if (item.detected_keywords && item.detected_keywords.length > 0) {
                    item.detected_keywords.forEach(keyword => {
                        html += `<span class="badge bg-secondary me-1">${keyword}</span>`;
                    });
                } else {
                    html += '<small class="text-muted">Нет</small>';
                }
                html += '</td>';
                
                html += `<td>${item.date ? new Date(item.date).toLocaleDateString() : 'Неизвестно'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
        }
        
        html += '</div>';
    } else {
        // Fallback для старого формата
        html += '<div class="col-md-6">';
        html += '<h6>Общая информация</h6>';
        html += '<ul class="list-group list-group-flush">';
        html += `<li class="list-group-item">Платформа: ${results.platform}</li>`;
        html += `<li class="list-group-item">Аккаунт: ${results.account_url}</li>`;
        html += `<li class="list-group-item">Проанализировано постов: ${results.posts_analyzed}</li>`;
        html += `<li class="list-group-item">Дата анализа: ${new Date(results.analysis_date).toLocaleString()}</li>`;
        html += '</ul></div>';
        
        // Результаты классификации
        html += '<div class="col-md-6">';
        html += '<h6>Результаты классификации</h6>';
        html += '<ul class="list-group list-group-flush">';
        html += `<li class="list-group-item">Экстремистский контент: <span class="badge bg-danger">${results.extremist_content_count || 0}</span></li>`;
        html += `<li class="list-group-item">Подозрительный контент: <span class="badge bg-warning">${results.suspicious_content_count || 0}</span></li>`;
        html += `<li class="list-group-item">Обычный контент: <span class="badge bg-success">${results.normal_content_count || 0}</span></li>`;
        html += '</ul></div>';
        
        html += '</div>';
        
        // Подробные результаты
        if (results.detailed_results && results.detailed_results.length > 0) {
            html += '<div class="mt-3">';
            html += '<h6>Подробные результаты</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped">';
            html += '<thead><tr><th>Пост</th><th>Классификация</th><th>Уверенность</th><th>Дата</th></tr></thead>';
            html += '<tbody>';
            
            results.detailed_results.forEach(result => {
                const badgeClass = result.classification === 'extremist' ? 'bg-danger' : 
                                  result.classification === 'suspicious' ? 'bg-warning' : 'bg-success';
                
                // Определяем цвет угрозы
                const threatColor = result.threat_color || '#6c757d';
                
                html += '<tr>';
                
                // Отображаем выделенный текст или обычный контент
                const displayContent = result.highlighted_text || result.content.substring(0, 100) + '...';
                html += `<td style="border-left: 4px solid ${threatColor}; padding-left: 8px;">${displayContent}</td>`;
                
                html += `<td><span class="badge ${badgeClass}">${result.classification}</span></td>`;
                html += `<td>${(result.confidence * 100).toFixed(1)}%</td>`;
                html += `<td>${new Date(result.date).toLocaleDateString()}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
        }
    }
    
    return html;
}

// Функция для форматирования результатов поиска по ключевым словам
function formatKeywordResults(results) {
    let html = '<div class="row">';
    
    // Общая статистика
    html += '<div class="col-12">';
    html += '<h6>Результаты поиска</h6>';
    html += `<p>Найдено результатов: <strong>${results.total_found || 0}</strong></p>`;
    
    // Статистика анализа
    if (results.analysis_summary) {
        html += '<div class="mb-3">';
        html += '<h6>Анализ контента</h6>';
        html += '<div class="d-flex gap-2">';
        html += `<span class="badge bg-danger">Экстремистский: ${results.analysis_summary.extremist_count || 0}</span>`;
        html += `<span class="badge bg-warning">Подозрительный: ${results.analysis_summary.suspicious_count || 0}</span>`;
        html += `<span class="badge bg-success">Обычный: ${results.analysis_summary.normal_count || 0}</span>`;
        html += '</div></div>';
    }
    
    html += '</div>';
    
    // Результаты по платформам
    if (results.platform_results) {
        Object.keys(results.platform_results).forEach(platform => {
            const platformResults = results.platform_results[platform];
            html += '<div class="col-12 mb-4">';
            html += `<div class="card"><div class="card-header d-flex justify-content-between align-items-center">`;
            html += `<span>${platform.toUpperCase()}</span>`;
            html += `<span class="badge bg-primary">${platformResults.count || 0} результатов</span>`;
            html += '</div>';
            html += '<div class="card-body">';
            
            if (platformResults.error) {
                html += `<div class="alert alert-warning">${platformResults.error}</div>`;
            } else if (platformResults.items && platformResults.items.length > 0) {
                html += '<div class="table-responsive">';
                html += '<table class="table table-sm">';
                html += '<thead><tr><th>Контент</th><th>Классификация</th><th>Уверенность</th><th>Источник</th><th>Дата</th></tr></thead>';
                html += '<tbody>';
                
                platformResults.items.forEach(item => {
                    const badgeClass = item.classification === 'extremist' ? 'bg-danger' : 
                                      item.classification === 'suspicious' ? 'bg-warning' : 'bg-success';
                    
                    const threatColor = item.threat_color || '#6c757d';
                    
                    html += '<tr>';
                    
                    // Отображаем выделенный текст
                    const displayContent = item.highlighted_text || item.content;
                    html += `<td style="border-left: 4px solid ${threatColor}; padding-left: 8px; max-width: 300px;">`;
                    html += `<div class="text-truncate" title="${item.content}">${displayContent}</div>`;
                    html += '</td>';
                    
                    html += `<td><span class="badge ${badgeClass}">${item.classification}</span></td>`;
                    html += `<td>${(item.confidence * 100).toFixed(1)}%</td>`;
                    
                    // Источник (канал или URL)
                    const source = item.channel || item.url || 'Неизвестно';
                    html += `<td><small>${source}</small></td>`;
                    
                    // Дата
                    const date = item.date ? new Date(item.date).toLocaleDateString() : 'Неизвестно';
                    html += `<td><small>${date}</small></td>`;
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            } else {
                html += '<p class="text-muted">Результатов не найдено</p>';
            }
            
            html += '</div></div></div>';
        });
    }
    
    html += '</div>';
    return html;
}

// Функция для загрузки активных сессий мониторинга
function loadActiveSessions() {
    fetch('/social-analysis/active-sessions')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('activeSessions');
            if (data.success && data.sessions.length > 0) {
                let html = '<div class="table-responsive">';
                html += '<table class="table table-striped">';
                html += '<thead><tr><th>Название</th><th>Статус</th><th>Платформы</th><th>Ключевые слова</th><th>Найдено</th><th>Статистика</th><th>Интервал</th><th>Действия</th></tr></thead>';
                html += '<tbody>';
                
                data.sessions.forEach(session => {
                    html += '<tr>';
                    html += `<td>${session.session_name}</td>`;
                    html += `<td><span class="badge ${session.is_active ? 'bg-success' : 'bg-secondary'}">${session.is_active ? 'Активен' : 'Остановлен'}</span></td>`;
                    
                    // Платформы
                    const platforms = session.platforms || [];
                    html += `<td>${platforms.length > 0 ? platforms.join(', ') : 'Не указаны'}</td>`;
                    
                    // Ключевые слова (обрезаем если слишком длинные)
                    const keywords = session.keywords || 'Не указаны';
                    const shortKeywords = keywords.length > 30 ? keywords.substring(0, 30) + '...' : keywords;
                    html += `<td title="${keywords}">${shortKeywords}</td>`;
                    
                    // Общее количество найденного
                    html += `<td><span class="badge bg-info">${session.found_count || 0}</span></td>`;
                    
                    // Статистика по типам контента
                    html += '<td>';
                    if (session.extremist_count > 0) {
                        html += `<span class="badge bg-danger me-1" title="Экстремистский контент">${session.extremist_count}</span>`;
                    }
                    if (session.suspicious_count > 0) {
                        html += `<span class="badge bg-warning me-1" title="Подозрительный контент">${session.suspicious_count}</span>`;
                    }
                    if (session.normal_count > 0) {
                        html += `<span class="badge bg-success me-1" title="Обычный контент">${session.normal_count}</span>`;
                    }
                    if (!session.extremist_count && !session.suspicious_count && !session.normal_count) {
                        html += '<span class="text-muted">-</span>';
                    }
                    html += '</td>';
                    
                    html += `<td>${session.check_interval} мин</td>`;
                    
                    // Действия
                    html += '<td>';
                    if (session.is_active && session.id !== 'example') {
                        html += `<button class="btn btn-sm btn-danger" onclick="stopSession('${session.id}')">Остановить</button>`;
                    } else if (session.id === 'example') {
                        html += '<span class="text-muted">-</span>';
                    } else {
                        html += '<span class="text-muted">Остановлен</span>';
                    }
                    html += '</td>';
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-muted">Нет активных сессий мониторинга</p>';
            }
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            document.getElementById('activeSessions').innerHTML = '<p class="text-danger">Ошибка загрузки сессий</p>';
        });
}

// Функция для остановки сессии мониторинга
function stopSession(sessionId) {
    if (confirm('Вы уверены, что хотите остановить эту сессию мониторинга?')) {
        fetch(`/social-analysis/stop-session/${sessionId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Сессия остановлена');
                loadActiveSessions();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при остановке сессии');
        });
    }
}
</script>
{% endblock %}