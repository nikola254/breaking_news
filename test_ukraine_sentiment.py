#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
–Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–æ–≤–æ—Å—Ç–µ–π –æ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
sys.path.append(os.path.join(os.path.dirname(__file__), 'app'))

from app.utils.ukraine_sentiment_analyzer import UkraineSentimentAnalyzer, get_ukraine_sentiment_analyzer

def test_sentiment_analyzer():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏"""
    
    print("=" * 80)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ê–ù–ê–õ–ò–ó–ê–¢–û–†–ê –¢–û–ù–ê–õ–¨–ù–û–°–¢–ò –£–ö–†–ê–ò–ù–°–ö–ò–• –ù–û–í–û–°–¢–ï–ô")
    print("=" * 80)
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    analyzer = get_ukraine_sentiment_analyzer()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤
    test_news = [
        {
            'title': '–ü–æ–∑–∏—Ç–∏–≤–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–ü–æ–¥–ø–∏—Å–∞–Ω–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–º–∏—Ä–∏–∏. –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –æ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–∏ –æ–≥–Ω—è –∏ –Ω–∞—á–∞–ª–µ –º–∏—Ä–Ω—ã—Ö –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤. –ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–∞—è –ø–æ–º–æ—â—å –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–µ —Ä–∞–π–æ–Ω—ã.',
            'expected': 'positive'
        },
        {
            'title': '–ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –∞—Ç–∞–∫–∞ –Ω–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –º–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∂–µ—Ä—Ç–≤—ã —Å—Ä–µ–¥–∏ –º–∏—Ä–Ω–æ–≥–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—è. –†–∞–∑—Ä—É—à–µ–Ω—ã –∂–∏–ª—ã–µ –¥–æ–º–∞ –∏ –±–æ–ª—å–Ω–∏—Ü—ã.',
            'expected': 'negative'
        },
        {
            'title': '–í–æ–µ–Ω–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–ê—Ä–º–µ–π—Å–∫–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ–ª–∏ –Ω–∞—Å—Ç—É–ø–∞—Ç–µ–ª—å–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é. –ó–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã —Ç–∞–Ω–∫–∏, –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è –∏ –∞–≤–∏–∞—Ü–∏—è. –ó–∞—Ö–≤–∞—á–µ–Ω—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.',
            'expected': 'negative'
        },
        {
            'title': '–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–ö—Ä–∞—Å–Ω—ã–π –ö—Ä–µ—Å—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª —ç–≤–∞–∫—É–∞—Ü–∏—é –¥–µ—Ç–µ–π –∏ –∂–µ–Ω—â–∏–Ω –∏–∑ –∑–æ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞. –í–æ–ª–æ–Ω—Ç–µ—Ä—ã –¥–æ—Å—Ç–∞–≤–∏–ª–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –ø–æ–º–æ—â—å –∏ –ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –±–µ–∂–µ–Ω—Ü–∞–º.',
            'expected': 'positive'
        },
        {
            'title': '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–°–æ—Å—Ç–æ—è–ª–∞—Å—å –≤—Å—Ç—Ä–µ—á–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π –¥–µ–ª–µ–≥–∞—Ü–∏–π. –û–±—Å—É–∂–¥–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π. –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π.',
            'expected': 'neutral'
        },
        {
            'title': '–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –Ω–æ–≤–æ—Å—Ç—å',
            'text': '–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –≤—ñ–π—Å—å–∫–∞ –∑–≤—ñ–ª—å–Ω–∏–ª–∏ –Ω–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç. –ù–∞–¥–∞–Ω–∞ –≥—É–º–∞–Ω—ñ—Ç–∞—Ä–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –º—ñ—Å—Ü–µ–≤–æ–º—É –Ω–∞—Å–µ–ª–µ–Ω–Ω—é. –í—ñ–¥–Ω–æ–≤–ª—é—î—Ç—å—Å—è –º–∏—Ä–Ω–µ –∂–∏—Ç—Ç—è –≤ —Ä–µ–≥—ñ–æ–Ω—ñ.',
            'expected': 'positive'
        }
    ]
    
    print("\n–ê–ù–ê–õ–ò–ó –¢–ï–°–¢–û–í–´–• –ù–û–í–û–°–¢–ï–ô:")
    print("-" * 80)
    
    for i, news in enumerate(test_news, 1):
        print(f"\n{i}. {news['title']}")
        print(f"–¢–µ–∫—Å—Ç: {news['text'][:100]}...")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        result = analyzer.analyze_sentiment(news['text'])
        category = analyzer.get_sentiment_category(result['sentiment_score'])
        
        print(f"\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:")
        print(f"  –û–±—â–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {result['sentiment_score']:.3f} ({category})")
        print(f"  –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª: {result['positive_score']:.3f}")
        print(f"  –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª: {result['negative_score']:.3f}")
        print(f"  –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–ª: {result['neutral_score']:.3f}")
        print(f"  –í–æ–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: {result['military_intensity']:.3f}")
        print(f"  –ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π —Ñ–æ–∫—É—Å: {result['humanitarian_focus']:.3f}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è–º
        expected = news['expected']
        status = "‚úì" if category == expected else "‚úó"
        print(f"  –û–∂–∏–¥–∞–ª–æ—Å—å: {expected}, –ø–æ–ª—É—á–µ–Ω–æ: {category} {status}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        keyword_counts = result['keyword_counts']
        print(f"  –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: pos={keyword_counts['positive']}, neg={keyword_counts['negative']}, neu={keyword_counts['neutral']}, mil={keyword_counts['military']}, hum={keyword_counts['humanitarian']}")
        
        print("-" * 40)
    
    print("\n–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–ê–ö–ï–¢–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê:")
    print("-" * 80)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    texts = [news['text'] for news in test_news]
    batch_results = analyzer.analyze_batch(texts)
    
    print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(batch_results)} —Ç–µ–∫—Å—Ç–æ–≤")
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    aggregated = analyzer.get_aggregated_sentiment(texts)
    print(f"\n–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
    print(f"  –°—Ä–µ–¥–Ω—è—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {aggregated['sentiment_score']:.3f}")
    print(f"  –°—Ä–µ–¥–Ω–∏–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª: {aggregated['positive_score']:.3f}")
    print(f"  –°—Ä–µ–¥–Ω–∏–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª: {aggregated['negative_score']:.3f}")
    print(f"  –°—Ä–µ–¥–Ω—è—è –≤–æ–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: {aggregated['military_intensity']:.3f}")
    print(f"  –°—Ä–µ–¥–Ω–∏–π –≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π —Ñ–æ–∫—É—Å: {aggregated['humanitarian_focus']:.3f}")
    
    print("\n–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ë–´–°–¢–†–´–• –§–£–ù–ö–¶–ò–ô:")
    print("-" * 80)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –±—ã—Å—Ç—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    from app.utils.ukraine_sentiment_analyzer import analyze_ukraine_news_sentiment, get_ukraine_news_sentiment_category
    
    test_text = "–ü–æ–¥–ø–∏—Å–∞–Ω–æ –º–∏—Ä–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞"
    quick_result = analyze_ukraine_news_sentiment(test_text)
    quick_category = get_ukraine_news_sentiment_category(test_text)
    
    print(f"–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞: '{test_text}'")
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {quick_result['sentiment_score']:.3f} ({quick_category})")
    
    print("\n" + "=" * 80)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("=" * 80)

def test_error_handling():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
    
    print("\n–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö:")
    print("-" * 80)
    
    analyzer = get_ukraine_sentiment_analyzer()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
    result = analyzer.analyze_sentiment("")
    print(f"–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç: {result['sentiment_score']} (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0.0)")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º None
    result = analyzer.analyze_sentiment(None)
    print(f"None: {result['sentiment_score']} (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0.0)")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
    result = analyzer.analyze_sentiment("–∞")
    print(f"–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç: {result['sentiment_score']}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    result = analyzer.analyze_sentiment("–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤")
    print(f"–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç: {result['sentiment_score']}")
    
    print("–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úì")

if __name__ == "__main__":
    try:
        test_sentiment_analyzer()
        test_error_handling()
        
        print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)